<%= stylesheet_link_tag "chat" %>
<!--<% if @over_ten %>
  <%= link_to 'Show Previous Messages', '?m=all' %>
<% end %>-->
<script>
  $(document).on('ready page:load', function() {
    var objDiv = document.getElementById("ui-segment");
    objDiv.scrollTop = objDiv.scrollHeight;

    <% if @transaction && @transaction.status == "Accepted" %>
      setTimeout(function() {
       $('.companion-modal').html('<%= escape_javascript(render partial: 'common/companion_modal') %>')
       $('#shareCompanionModal').modal('show');
      }, 1000);
    <% end %>

    var adaebot= $( "span:contains('AdaeBot:')" ).parent().parent().addClass('botmsg');
    adaebot.css({'background':'#7ed321','color':'#fff','margin-left':'4em','margin-right':'4em'});
    var datetime = adaebot.next();
    datetime.css({'margin-left':'6em','margin-right':'6em'});

  });

  function clickAndDisable(link) {
     // disable subsequent clicks
    link.onclick = function(event) {
      event.preventDefault();
    }
  }
</script>

<div class="companion-modal"></div>

<div class="page-content">
  
  <!-- Chat area pre-transaction request -->
  <% if @conversation.sender_id == current_user.id %>
    <div class="username"> Conversation with <%=User.find_by(id: @conversation.recipient_id).name %></div>
  <% else %>
    <div class="username"> Conversation with <%=User.find_by(id: @conversation.sender_id).name %></div>
  <% end %>

  <div class="user-profile">
    <% if @conversation.sender_id == current_user.id %>
    <p id="user-name"><%=User.find_by(id: @conversation.recipient_id).name %></p>
    <p><%= image_tag(User.find_by(id: @conversation.recipient_id).avatar.url(:med), class:"avatar") %></p>
    <% else %>
      <p id="user-name"><%=User.find_by(id: @conversation.sender_id).name %></p>
      <p><%= image_tag(User.find_by(id: @conversation.sender_id).avatar.url(:med), class:"avatar") %></p>
    <% end %>
  </div>

  <div class="chat-area">
    <div class="chat-content">
      <div id="ui-segment">
        <% @messages.each do |message| %>
          <% if message.body %>
            <% user = User.find(message.user_id) %>
            <% if user.id == current_user.id %>
              <div class="chat-bubble">
                <div class="bubble-text">
                  <span class="msg"><%= message.body %></span>
                </div>
              </div>
              <div class="chat-time">
                <%= message.message_time %>
              </div>
            <% else %>
              <div class="opp-chat-bubble">
                <div class="bubble-text">
                  <span class="msg"><%= message.body %></span>
                </div>
              </div>
              <div class="opp-chat-time">
                <%= message.message_time %>
              </div>
            <% end %>
          <% end %>
        <% end %>
      </div>
    </div>
      <%= form_for [@conversation, @message] do |f| %>
        <div class="reply-field">
            <%= f.text_area :body, :placeholder => "Type your message here. Refresh your browser to check for new messages.", class: "form-control" %>
            <%= f.text_field :user_id, value: current_user.id, type: "hidden"%>

            <% if @transaction %>
              <%= f.hidden_field :item_id, :value => "#{@item.id}" %>
            <% end %>

            <%= f.submit "Send", class: "reply_btn", data: {disable_with: "Sending..."} %>
        </div>
      <% end %>
  </div>

  <% unless @transaction %>
  <!--<div class="guidelines">
    <div class="guidelines-wrap">
      <p id="guide-title"> Useful Guidelines to Keep In Mind</p>
      <p class="tips"><b class="tip-title">Work Out All The Details.</b></br> Make sure to agree on a meeting place, how much work to be done etc. before sending/accepting any requests.</p>
        <p class="tips"><b class="tip-title">Get the Adae Scanner App!</b></br> The app is the tool you will need to securely send/receive payment via QR Code Scanning, and to verify the service actually happened.</p>
        <p class="tips"><b class="tip-title">The Scanner App is your receipt.</b> </br> Scan once before the service, and scan once after. Each scan is time-stamped and proof of your start time and end time. This can be referenced in case of disputes/loss of payment.<br><br><em> For For Flat Rate Services & Services Offering Products: only ONE SCAN is needed. Payment will be sent whenever this scan occurs.</em></p>
        <p class="tips"><b class="tip-title">We Discourage Cash Payments.</b> </br> Adae will not be able to keep track of your transactions if you use cash. Because of this, we cannot be held accountable for any disputes and/or loss of payment.</p>
   </div>
 </div>-->
  <% end %>

    <!-- This segment is for chat rooms with a transaction START-->
    <% if @transaction %>
      <div class="request-box">
        <% if @transaction.seller_id == current_user.id %> <!--condition to see if current user is also the seller-->
          <% if @item.listing_type == "sell" %> <!--condition to set the opposite listing value-->
            <p id="heading"><%= User.find_by(id: @transaction.buyer_id).name %> requested to buy</p>
          <% elsif @item.listing_type == "timeoffer" %>
            <p id="heading"><%= User.find_by(id: @transaction.buyer_id).name %> requested service</p>
          <% else %>
            <p id="heading"><%= User.find_by(id: @transaction.buyer_id).name %> requested to <%= @item.listing_type %></p>
          <% end %>
        <% else %>
          <% if @item.listing_type == "sell" %>
            <p id="heading">You requested to buy</p>
          <% elsif @item.listing_type == "timeoffer" %>
            <p id="heading">You requested the following service</p>
          <% else %>
            <p id="heading">You requested to <%= @item.listing_type %></p>
          <% end %>
        <% end %> <!--condition to see if current user is also the seller-->
        <p id="item-title"><%= @item.title %></p>
        <p><%= image_tag @picture.image, class: "item-image" %></p>
        <p id="status">Transaction Status: <%= @transaction.status %></p>

        <% if @transaction.seller_id == current_user.id && @transaction.status == 'Pending' %>
          <li class="listings">
      			<div class="item-edit-delete-buttons">
      				<%= link_to 'Accept', accept_path(item_id: @item.id, transaction: @transaction.id), class: "edit-item", :onclick => 'clickAndDisable(this)' %>
      				<%= link_to 'Decline', @transaction, method: :delete, class: "delete-item", data: {confirm: "Are you sure you want to decline this request?"}  %>
      			</div>
      		</li>
        <% elsif @transaction.buyer_id == current_user.id %>
          <p id ="cancel"> Need to Cancel?
            <span style="text-decoration: underline; color: #FF2641">
              <%= link_to 'Click Here', contact_path %>
            </span>
          </p>
        <% end %>
      </div>
      <% if @item.listing_type == "lease" && @item.status != "Sold" && current_user.id != @item.user_id && (["In Progress"].include?(@transaction.status)) %>
        <div class="request-box" style="margin-bottom: -5px; height: 140px;">
          <p style="font-weight: 500px; color: #4a4a4a; line-height: normal;">If you would like to buy the item during your rental period, click below.</p>
            <%= link_to 'Request to Purchase', purchase_lease_path(item_id: @item.id, transaction: @transaction.id, lease: "true"), class: "lease-buy-item",
            data: {confirm: "Are you sure you want to purchase this item?"} %>
        </div>
      <% end %>

      <% if @transaction.seller_id == current_user.id %>
        <div class="helpful-tip">
          <p id="seller">Make sure you both agree on a time and place to meet before accepting this request.
              Your account will NOT be credited until you both meet and your In-App QR code is scanned.</p>
        </div>
      <% else %>
        <div class="helpful-tip">
          <p id="seller">Your Credit or Debit Card will be charged once your
                request has been accepted.
                Donâ€™t worry, your money will NOT be sent to
                the other party until you both meet up and scan the in-app QR code.</p>
        </div>
      <% end %>
    </div>
  <% end %>
  <!-- chat room with trasaction END -->
</div>
